CXXFLAGS = -O3 -isystem ../include
CXXFLAGS_DBG = -g

# TODO: implement bin_mystuff_dep = ... that lists the objects on which this linking or packaging need to be complete, and $(MAKE) -C $(shell dirname $(dep)) $(shell basename $(dep)) them
# to be used in binaries, libraries and linking tests to their tested objects  

LDFLAGS_TEST = 
LDFLAGS = -lboost_regex

## static library packages and their sources
bin_package = cpparse

bin_cpparse_src = cpparse.cpp
bin_cpparse_export = $(bin_cpparse_src) 
bin_cpparse_deps = libcppelib.a

## static library packages and their sources
lib_package = cppelib

lib_cppelib_src = ParseException.cpp AmplRecord.cpp AmplRecordParser.cpp AmplData.cpp
lib_cppelib_export = $(lib_cppelib_src)
lib_cppelib_deps = ## Include some support to get dependency to object files

## test packages and their sources
test_package = #array-test

test_array-test_src = test_array.c
test_array-test_export = $(test_array-test_src) array.c
test_array-test_deps = libpelib.a
test_array-test_ldflags = ## Include some support to get per-test binary linker flags

## Additional settings
clean = *.o *.txt *.fig *.bin *.e

## Here begin the region you don't want to mess with ##
CFLAGS += $(if $(DEBUG),$(CFLAGS_DBG),-DNDEBUG)
subdirs = 

lib_target = $(lib_package:%=lib%.a)

%.o: %.cpp ## TODO: insert autogenerated dependence list
#	$(CXX) -E $(CXXFLAGS) $(CPPFLAGS) -o $(@:.o=.e) $<
	$(CXX) -c $(CXXFLAGS) $(CPPFLAGS) -o $@ $<

all: $(bin_package) $(lib_target) $(test_package)

$(bin_package): $(foreach var,$(bin_package:%=bin_%_src),$(patsubst %.cpp, %.o, $(call $(var))))
	@if [ "$(strip $(call $(@:%=bin_%_deps)))" != "" ]; then $(MAKE) -C $(dir $(call $(@:%=bin_%_deps))) $(notdir $(call $(@:%=bin_%_deps))); fi
	$(CXX) -o $@ $(LDFLAGS) $(bin_$@_ldflags) $(bin_$@_src:.cpp=.o) $(call $(@:%=bin_%_deps))

$(lib_target): $(foreach var,$(lib_package:%=lib_%_src),$(patsubst %.cpp, %.o, $(call $(var))))
	ar rs $@ $(foreach var,$(lib_package:%=lib_%_src),$(patsubst %.cpp, %.o, $(call $(var)))) 2>&1
	
$(test_package): $(foreach var,$(test_package:%=test_%_src),$(patsubst %.cpp, %.o, $(call $(var))))
	@if [ "$(strip $(call $(@:%=test_%_deps)))" != "" ]; then $(MAKE) -C $(dir $(call $(@:%=test_%_deps))) $(notdir $(call $(@:%=test_%_deps))); fi
	$(CXX) -o $@ $(LDFLAGS_TEST) $(test_$@_ldflags) $(test_$@_src:.cpp=.o) $(call $(@:%=test_%_deps))
	
dist:
	mkdir -p $(distdir)
	cp Makefile $(distdir)
	cp $(sort $(foreach var,$(bin_package:%=bin_%_export),$(call $(var)))) $(distdir)
	cp $(sort $(foreach var,$(lib_package:%=lib_%_export),$(call $(var)))) $(distdir)
	cp $(sort $(foreach var,$(test_package:%=test_%_export),$(call $(var)))) $(distdir)
        
clean:
	$(RM) $(test_package)
	$(RM) $(bin_package)
	$(RM) $(patsubst %,lib%.a, $(lib_package))
	$(RM) $(clean)

check: $(test_package)
	$(shell echo for i in "$(foreach var,$(test_package),$(var))"\; do ./\$$i\; done)
        
install: $(lib_target)
	install -d $(DESTDIR)$(libdir)
	install -m 644 $(lib_target) $(DESTDIR)$(libdir)

uninstall:
	-rm $(DESTDIR)$(libdir)/$(lib_package:%=lib%.a)
	
FORCE:
.PHONY: all clean check install uninstall dist FORCE
